name : Terraform deploy

on:
    push:
        branches:
            - main
    workflow_dispatch:
      inputs:
          action:
              description: 'Terraform action to perform'
              required: true
              default: apply
              type: choice
              options:
                  - apply 
                  - destroy
env:
    AWS_REGION: us-east-1
    TF_VERSION: 1.6.0
jobs:
  terraform:
    name : run Terraform
    runs-on : ubuntu-latest


    steps:
      - name: checkout code
        run: actions/checkout@4
        
      - name: configure AWS
        uses: aws-actions/configure-aws-credentials@v3
        with: 
         aws-access-key-id : ${{secrets.AWS_ACCESS_KEY_ID}}
         aws-secret-access-key: ${{secrets.AWS_SECRET_KEY_ID}}
         aws-region: ${{env.AWS_REGION}}
         
      - name: setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform : ${{env.TF_VERSION}}
        
      - name: Terraform init stage
        run: terraform init
        
      - name:  Terraform plan stage
        run: terraform plan
        
      - name: Terraform apply stage
        if: github.event_name == 'push' || github.event.inputs.action =='apply'
        run: terraform plan -auto-approve
        
      - name: Terraform destroy stage
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action =='destroy'

        run: terraform destroy -auto-approve









